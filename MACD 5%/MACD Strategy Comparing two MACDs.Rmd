---
title: "MACD Strategy"
params:
  fast1: 5
  slow1: 50
  fast2 : 5
  slow2: 50
  sig1: 17
  sig2: 30
  ticker: "BTC-USD"
  datefrom:
    label: "Date"
    value: "2017-01-01"
    input: date
    min: "2010-01-01"
    max: Sys.Date()

output: html_document
date: "`r Sys.Date()`"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```
```{r}
library(quantmod)
library(PerformanceAnalytics)
library(DT)
library(plotly)
library(ggplot2)
library(dplyr)

ticker <- params$ticker#params$ticker #ticker to run analysis
datefrom <- params$datefrom #date to pull data from
dateto <- Sys.Date()#date to pull date to
fast1 <- params$fast1
fast2 <- params$fast2
slow1 <- params$slow1
slow2 <- params$slow2
sig1 <- params$sig1
sig2 <- params$sig2
maxDay <- (max(c(fast1,fast2,slow1,slow2)))
maxSig <- max(c(sig1,sig2))
maxDay <- maxDay + maxSig
trade <- c() #trade signal
trade[1:(maxDay+1)] <- 0
```

```{r}
prices <- getSymbols(ticker, from = datefrom, to = dateto, src = "yahoo", auto.assign = FALSE)
price <- Cl(prices)


#trading signal
price <- na.approx(price) #remove NAs from data by interpolation
mac1 <- MACD(price,nFast = fast1, nSlow = slow1, nSig = sig1)
mac2 <- MACD(price,nFast = fast2, nSlow = slow2, nSig = sig2)
rsi <- RSI(price,n = 14, maType=list(maUp=list(EMA),maDown=list(WMA)))
sma_rsi <- SMA(rsi,50)

position <- 0 #position 0 means not in, 1 means in
for (i in (maxDay+1):length(price)){
  if (position == 0){
    if (mac1$macd[i] > 0 & mac1$signal[i] > Lag(mac1$signal) & mac1$macd[i] > 5){
      trade[i] <- 1
      position <- 1
    }
    else {
      trade[i] <- 0
    }
    
  } else if (position == 1){
    if (mac2$macd[i] < mac2$signal[i]) {
      trade[i] <- -1
      position <- 0
    } else {
      trade[i] <- 0
      
    }
  }
}
trade <- reclass(trade,price)
rsi <- reclass(rsi,price)
sma_rsi <- reclass(sma_rsi,price)
rsi <- merge(rsi,sma_rsi)
```

```{r}
#tables
table3 <- merge(price,trade,mac1,mac2)
names(table3) <- c("price","trade","macd","macdSignal","macd2","macd2Signal")
trans <- subset(table3,trade != 0)
trans$return <- (trans$price - Lag(trans$price))/Lag(trans$price) 
trans$return <- ifelse(trans$trade == 1, 0,trans$return)
trans$cumReturn <- 1 + trans$return
trans$cumReturn <- cumprod(trans$cumReturn)  #Table with transactions and cumulative return

#Data frame of table with transactions and cumulative return for DT interactive Table
x <- data.frame(trans)
x$date <- row.names(x)
x <- x %>% select(c("date","price","return","cumReturn","trade"))
endCumReturn <- last(x$cumReturn)
numTransactions <- length(x$price)

#table with every day price with all variables, includes days without transactions
table2 <- merge(trans,price,mac1,mac2)
names(table2) <- (c("price","trade","macdTrade","macdSignalTrade","macd2Trade","macd2SignalTrade","return","cumReturn","BTC.USD.Close","macd1","signal","macd2","signal.1"))

#data frame of table2 of everyday price with all variables
table4 <- data.frame(table2)
table4$Date <- index(table2)
table4 <- table4 %>% select(c("Date","BTC.USD.Close","macd1","signal","macd2","signal.1","price","trade","return","cumReturn"))
names(table4) <- c("date","price","macd1","signal1","macd2","signal2","priceTraded","trade","return","cumReturn")
```
```{r}
#plots

#plot Cumulative return
plot <- ggplot(trans, aes(x = Index)) + 
  geom_line(aes(y=cumReturn,colour = 'orange',label = return)) +
  guides(colour = "none") + 
  labs(title = "Cumulative Return",subtitle = "Plot of cumulative return", x="Date",y="Return",caption="*Trade value of 1 signals a buy, -1 signals a sell.") +
  theme_light()
c <- ggplotly(plot)

#plot price and transactions
plot <- ggplot(table2, aes(x = Index)) + 
  geom_point(aes(y=price,colour = trade,label = return)) +
  guides(colour = "none") + 
  geom_line(aes(y=BTC.USD.Close),color = 'grey') +
  labs(title = "Price and Transactions", x="Date",y="Price") +
  theme_light()
a <- ggplotly(plot)

#plot prices with candlestick
names(prices) <- c("open","high","low","close","volume","adjusted")
df <- prices
df <- merge(df,trans) 
df <- data.frame(df)
df <- df %>% select(open,high,low,close,volume,trade,price)
df$date <- row.names(df)
df$trade <- ifelse(df$trade == 1,"buy",ifelse(df$trade == -1,"sell",NA))

fig <- df %>% plot_ly(x = ~date, type="candlestick",
                      open = ~open, close = ~close,
                      high = ~high, low = ~low, name = "Price") 
fig <- fig %>% add_trace(x = ~date, y = ~price,type='scatter', mode = 'markers',symbol = "triangle",name = "trades",color = ~trade,colors = c("blue","black"),size = 10)
fig <- fig %>% layout(title = "Price and Transactions",
                      xaxis = list(rangeslider = list(visible = F)))


#plot indicators and transactions
plot <- ggplot(table2, aes(x = Index)) + 
  geom_point(aes(y=macdTrade,colour = trade,label = return)) +
  guides(colour = "none") + 
  geom_line(aes(y=macd1),color = '#b30000',label = "macd1") +#fee8c8
  geom_line(aes(y=signal),color = '#feb24c',alpha = .5,label = "signal of macd1") +
  geom_line(aes(y=macd2),color = '#54278f',label = "macd2") +
  geom_line(aes(y=signal.1),color = '#dadaeb',label = "signal of macd2") +
  labs(title = "Indicators",x="Date",y="MACD Value") +
  theme_light()
b <- ggplotly(plot)

#plot RSI
plot <- ggplot(rsi, aes(x = Index)) + 
  geom_line(aes(y=rsi),color = '#e0f3f8') +
  geom_line(aes(y=SMA),color = "#74add1") +
  geom_hline(yintercept=70, linetype="dashed", color = "#fdbb84") +
  geom_hline(yintercept=30, linetype="dashed", color = "#fdbb84") +
  guides(colour = "none") + 
  labs(title = "RSI",subtitle = "Plot of RSI", x="Date",y="Return",caption="*Trade value of 1 signals a buy, -1 signals a sell.") +
  theme_light()
rsi_plot <- ggplotly(plot)

#box plot table and plots
BP1 <- data.frame(subset(trans,trade == -1))
BP1$gains <- ifelse(BP1$return > 0, "pos","neg")

plot <- ggplot(BP1) + 
  geom_boxplot(aes(x = gains, y = return, group = gains,fill = gains),notch = F) +
  scale_x_discrete(labels= c('Negative Returns','Positive Returns')) +
  stat_summary(aes(x = gains, y = return, group = gains),fun.y=mean, geom="point", shape=8, size=2,color = 'red') + 
  geom_jitter(aes(x = gains, y = return, group = gains),shape=16, size = 1,width = 0.2) +
  theme_minimal()
plot <- plot + scale_fill_manual(values=c("#fdae61", "#66bd63"))
plot2 <- ggplot(BP1) +
  geom_boxplot(aes(x = "all",y = return),fill = '#80cdc1') +
  scale_x_discrete(labels= 'All Returns') +
  geom_jitter(aes(x = "all",y = return),shape=16, size = 1,width = 0.2) +
  stat_summary(aes(x = "all",y = return),fun.y=mean, geom="point", shape=8, size=2,color = "red") + 
  theme_minimal()
plot <- ggplotly(plot)
plot2 <- ggplotly(plot2)
bpFig <- subplot(plot, plot2) %>% layout(title = "Distribution of Returns")

```
**Introduction**

This Document describes and tests a backtesting strategy which employs the comparison of Moving Average Convergence/Divergence (MACD) of a single asset. MACD calculates the difference between fast and slow exponential moving averages (EMA). For this iteration **MACD1 fast EMA is `r params$fast1`** and **slow EMA is `r params$slow1`** with a **signal of `r params$sig1`** and **MACD2 fast EMA is `r params$fast2`** and **slow EMA is `r params$slow2`** days with a **signal of `r sig2`**. This strategy is run from `r params$date` through `r Sys.Date()` and the first transaction is a buy. The strategy uses the following buy/sell triggers:

**Buy** when MACD1 rises above 5%, and MACD1 signal is greater than MACD1 signal from the day before and the last transaction was not a buy. 

**Sell** when MACD2 falls below MACD2 Signal and the last transaction was a buy. 

This strategy has an ending cumulative return of **`r endCumReturn`** and a total of **`r numTransactions`** transactions. See figures and tables below for analysis of
```{r}
#print plot of price and transactions
a

fig

#print table of transactions only
datatable(x,class = 'cell-border stripe',rownames = FALSE,caption = 'Table 1: Showing only days for which a transaction was carried out.',filter= 'top',options = list(autowidth=T))

#print plot of indicators and transactions
b

#print interactive table of every day regardless of transaction
datatable(table4,class = 'cell-border stripe',rownames = FALSE,caption = 'Table 1: Showing all days regardless of transaction',filter= 'top',options = list(autowidth=T))


rsi_plot

#print graph of cumulative return
c

#print boxplot
bpFig

write.csv(x,"TransactionDays.csv")
write.csv(table4,"AllDays.csv")
```